<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parasut Token Service</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
    .header p { opacity: 0.9; font-size: 1.1em; }
    .content { padding: 30px; }
    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .status-card { background: #f8f9fa; border-radius: 10px; padding: 25px; border-left: 5px solid #667eea; }
    .status-card h3 { color: #333; margin-bottom: 15px; font-size: 1.3em; }
    .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin: 5px 0; }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .status-warning { background: #fff3cd; color: #856404; }
    .token-display { background: #2d3748; color: #a0aec0; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; word-break: break-all; margin: 15px 0; position: relative; overflow-x: auto; }
    .token-display::before { content: 'Bearer Token'; position: absolute; top: -10px; left: 15px; background: #2d3748; color: #667eea; padding: 0 10px; font-size: 12px; font-weight: bold; }
    .controls { display: flex; gap: 15px; flex-wrap: wrap; margin: 30px 0; }
    .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
    .btn-success { background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); }
    .api-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin: 20px 0; }
    .api-section h3 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
    .api-list { display: grid; gap: 10px; }
    .api-item { background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .api-method { background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold; margin-right: 15px; }
    .api-method.post { background: #51cf66; }
    .countdown { font-size: 1.5em; font-weight: bold; color: #667eea; text-align: center; margin: 20px 0; }
    .old-tokens { max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px; }
    .old-token-item { background: white; margin: 8px 0; padding: 12px; border-radius: 6px; border-left: 3px solid #dee2e6; font-family: 'Courier New', monospace; font-size: 0.9em; }
    @media (max-width: 768px) { .header h1 { font-size: 2em; } .status-grid { grid-template-columns: 1fr; } .controls { justify-content: center; } .btn { width: 100%; margin: 5px 0; } }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🚀 Parasut Token Service</h1>
      <p>Otomatik Bearer Token Yönetim Sistemi</p>
    </div>

    <div class="content">
      <div class="status-grid">
        <div class="status-card">
          <h3>📊 Sistem Durumu</h3>
          <div id="badgeRunning" class="status-badge">—</div>
          <p><strong>Platform:</strong> <span id="platform">-</span></p>
          <p><strong>Uptime:</strong> <span id="uptime">-</span></p>
        </div>

        <div class="status-card">
          <h3>🎯 Token Durumu</h3>
          <div id="badgeToken" class="status-badge">—</div>
          <p id="lastUpdatedRow" style="display:none"><strong>Son Güncelleme:</strong><br /><span id="lastUpdated">-</span></p>
          <p><strong>Eski Token Sayısı:</strong> <span id="oldCount">-</span></p>
        </div>

        <div class="status-card">
          <h3>⏰ Zamanlayıcı</h3>
          <div id="timerState" class="status-badge status-inactive">Timer Durdu</div>
          <div id="countdown" class="countdown" style="display:none">—:—</div>
        </div>
      </div>

      <div id="tokenBox" class="token-display" style="display:none"></div>

      <div class="controls">
        <button class="btn btn-success" onclick="startService()"><span id="startBtn">▶️ Başlat</span></button>
        <button class="btn btn-danger" onclick="stopService()"><span id="stopBtn">⏹️ Durdur</span></button>
        <a href="/api/bearer" class="btn" target="_blank">🎯 Bearer Token</a>
        <a href="/api/time" class="btn" target="_blank">⏰ Zaman</a>
        <a href="/api/old-bearer" class="btn" target="_blank">📂 Eski Tokenler</a>
        <a href="/api/status" class="btn" target="_blank">📊 Durum</a>
      </div>

      <div class="api-section">
        <h3>🔌 API Endpoints</h3>
        <div class="api-list">
          <div class="api-item">
            <div><span class="api-method">GET</span><strong>/api/bearer</strong> - Güncel Bearer token</div>
            <a href="/api/bearer" target="_blank" class="btn">Test Et</a>
          </div>
          <div class="api-item">
            <div><span class="api-method">GET</span><strong>/api/time</strong> - Yenilenme süresi</div>
            <a href="/api/time" target="_blank" class="btn">Test Et</a>
          </div>
          <div class="api-item">
            <div><span class="api-method">GET</span><strong>/api/old-bearer</strong> - Eski tokenler</div>
            <a href="/api/old-bearer" target="_blank" class="btn">Test Et</a>
          </div>
          <div class="api-item">
            <div><span class="api-method post">POST</span><strong>/api/start</strong> - Servisi başlat</div>
            <button onclick="startService()" class="btn btn-success">Çalıştır</button>
          </div>
          <div class="api-item">
            <div><span class="api-method post">POST</span><strong>/api/stop</strong> - Servisi durdur</div>
            <button onclick="stopService()" class="btn btn-danger">Çalıştır</button>
          </div>
        </div>
      </div>

      <div class="api-section">
        <h3>⏱️ Zamanlayıcı Ayarı</h3>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label for="intervalMinutes"><strong>Aralık (dakika):</strong></label>
          <input id="intervalMinutes" type="number" min="1" max="1440" step="1" value="10" style="padding:10px 12px;border-radius:8px;border:1px solid #ced4da; width:120px" />
          <button class="btn" onclick="saveInterval()">Kaydet</button>
          <span id="intervalInfo" style="opacity:0.8"></span>
        </div>
      </div>

      <div id="oldTokensSection" class="api-section" style="display:none">
        <h3>📂 Son Tokenler (<span id="oldCount2">0</span>)</h3>
        <div id="oldTokens" class="old-tokens"></div>
      </div>
    </div>
  </div>

  <script>
    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    function setBadge(el, isOk, okText, badText) {
      el.className = 'status-badge ' + (isOk ? 'status-active' : 'status-inactive');
      el.textContent = isOk ? okText : badText;
    }

    function formatDate(d) {
      try {
        const date = new Date(d);
        return date.toLocaleString('tr-TR');
      } catch { return '-'; }
    }

    async function refresh() {
      try {
  const [status, timeLeft, bearer, old] = await Promise.all([
          fetchJSON('/api/status'),
          fetchJSON('/api/time'),
          fetchJSON('/api/bearer').catch(() => null),
          fetchJSON('/api/old-bearer').catch(() => ({ oldTokens: [], totalOldTokens: 0 }))
        ]);

        // Sistem
        document.getElementById('platform').textContent = status.platform;
        document.getElementById('uptime').textContent = Math.floor(status.uptime / 60) + ' dakika';
        setBadge(document.getElementById('badgeRunning'), status.isAutoUpdateRunning, '✅ Aktif', '⏹️ Durduruldu');

        // Token durumu
        const hasToken = !!(bearer && bearer.bearerToken);
        setBadge(document.getElementById('badgeToken'), hasToken, '✅ Token Mevcut', '⚠️ Token Yok');
        document.getElementById('lastUpdatedRow').style.display = bearer && bearer.lastUpdated ? 'block' : 'none';
        if (bearer && bearer.lastUpdated) {
          document.getElementById('lastUpdated').textContent = formatDate(bearer.lastUpdated);
        }
        document.getElementById('oldCount').textContent = (old && old.totalOldTokens) || 0;

        // Token kutusu
        const tokenBox = document.getElementById('tokenBox');
        if (hasToken) {
          tokenBox.style.display = 'block';
          tokenBox.textContent = bearer.bearerToken;
        } else {
          tokenBox.style.display = 'none';
        }

        // Zamanlayıcı
        const timerState = document.getElementById('timerState');
        const countdownEl = document.getElementById('countdown');
        // fill interval input
        try {
          const msVal = timeLeft && timeLeft.intervalMs ? Number(timeLeft.intervalMs) : null;
          if (msVal) {
            const minutes = Math.round(msVal / 60000);
            const input = document.getElementById('intervalMinutes');
            if (input) input.value = minutes;
          }
        } catch {}
        if (status.isAutoUpdateRunning && timeLeft && timeLeft.timeToNextUpdate && typeof timeLeft.timeToNextUpdate.totalMs === 'number') {
          timerState.style.display = 'none';
          countdownEl.style.display = 'block';
          let ms = timeLeft.timeToNextUpdate.totalMs;
          updateCountdown(ms);
          window._countdownInterval && clearInterval(window._countdownInterval);
          window._countdownInterval = setInterval(() => {
            ms -= 1000;
            updateCountdown(ms);
            if (ms <= 0) { clearInterval(window._countdownInterval); location.reload(); }
          }, 1000);
        } else {
          countdownEl.style.display = 'none';
          timerState.style.display = 'inline-block';
        }

        // Eski tokenler
        const oldSection = document.getElementById('oldTokensSection');
        const oldList = document.getElementById('oldTokens');
        const count = (old && old.totalOldTokens) || 0;
        document.getElementById('oldCount2').textContent = count;
        oldSection.style.display = count > 0 ? 'block' : 'none';
        oldList.innerHTML = '';
        if (old && old.oldTokens) {
          old.oldTokens.slice(-5).reverse().forEach(t => {
            const div = document.createElement('div');
            div.className = 'old-token-item';
            div.innerHTML = `
              <div><strong>Token:</strong> ${t.token}</div>
              <div><strong>Oluşturulma:</strong> ${formatDate(t.createdAt)}</div>
              <div><strong>Değiştirilme:</strong> ${formatDate(t.replacedAt)}</div>
            `;
            oldList.appendChild(div);
          });
        }
      } catch (e) {
        console.error(e);
      }
    }

    function updateCountdown(ms) {
      const el = document.getElementById('countdown');
      const m = Math.max(0, Math.floor(ms / 60000));
      const s = Math.max(0, Math.floor((ms % 60000) / 1000));
      el.textContent = m + ':' + String(s).padStart(2, '0');
    }

  async function startService() {
      const btn = document.getElementById('startBtn');
      btn.innerHTML = '<div class="loading"></div> Başlatılıyor...';
      try {
        const data = await fetchJSON('/api/start', { method: 'POST' });
        alert(data.message);
        setTimeout(() => location.reload(), 1000);
      } catch (e) {
        alert('Hata: ' + e.message);
        btn.innerHTML = '▶️ Başlat';
      }
    }

  async function stopService() {
      const btn = document.getElementById('stopBtn');
      btn.innerHTML = '<div class="loading"></div> Durduruluyor...';
      try {
        const data = await fetchJSON('/api/stop', { method: 'POST' });
        alert(data.message);
        setTimeout(() => location.reload(), 1000);
      } catch (e) {
        alert('Hata: ' + e.message);
        btn.innerHTML = '⏹️ Durdur';
      }
    }

    async function saveInterval() {
      const input = document.getElementById('intervalMinutes');
      const minutes = Number(input.value);
      if (!Number.isFinite(minutes) || minutes < 1 || minutes > 1440) {
        alert('1 ile 1440 dakika arasında bir değer girin');
        return;
      }
      try {
        const res = await fetch('/api/interval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ intervalMinutes: minutes })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        document.getElementById('intervalInfo').textContent = `Kaydedildi: ${data.intervalMinutes} dk`;
        setTimeout(() => location.reload(), 800);
      } catch (e) {
        alert('Hata: ' + e.message);
      }
    }

    // Sayfayı periyodik güncelle
    setInterval(() => refresh(), 30000);
    refresh();
  </script>
</body>
</html>
